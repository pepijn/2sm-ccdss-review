#!/bin/bash

set -euxo pipefail

STUDY="$(basename "$1" .pdf)"

if [ $(gpg --decrypt "$1.gpg" | md5) != $(md5 < "$1") ]; then
   gpg --yes --encrypt --recipient p@epij.nl "$1"
fi

FRAGMENTS="fragments/$STUDY.yml"
ELEMENTS="elements/$STUDY.yml"

touch "$ELEMENTS"

TMP="$(gmktemp -t "$STUDY (tmp-XXX).org")"
python extract.py "$FRAGMENTS" < "$1" \
    | python summarize.py "$ELEMENTS" > "$TMP"

$EDITOR "$TMP"

python save_elements.py < "$TMP" > "$ELEMENTS"
